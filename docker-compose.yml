#  Copyright (c) University College London Hospitals NHS Foundation Trust
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
################################################################################


################################################################################
# Common
x-http-proxy: &http-proxy ${HTTP_PROXY}
x-https-proxy: &https-proxy ${HTTPS_PROXY}
x-no-proxy: &no-proxy localhost,0.0.0.0,127.0.0.1,uclvlddpragae02,ocr-forwarding-api,sparrow,sparrow-ocr,marker
x-proxy-common: &proxy-common
    HTTP_PROXY: *http-proxy
    http_proxy: *http-proxy
    HTTPS_PROXY: *https-proxy
    https_proxy: *https-proxy
    NO_PROXY: *no-proxy
    no_proxy: *no-proxy

x-build-args-common: &build-args-common
    <<: [*proxy-common]

x-common-env: &common-env
    DEBUG: ${DEBUG}
    LOG_LEVEL: ${LOG_LEVEL}
    TZ: ${TZ:-Europe/London}

networks:
  pyonb_ocr_api:
    driver: bridge

################################################################################
# Services
services:
  sparrow:
    profiles: [sparrow]
    build:
      context: src/ocr/sparrow
      dockerfile: Dockerfile
      args:
        <<: *build-args-common
        SPARROW_API_PORT: ${SPARROW_API_PORT}
    environment:
      <<: [*proxy-common, *common-env]
      CONTAINER_DATA_FOLDER: /data
      SPARROW_API_PORT: ${SPARROW_API_PORT}
    env_file:
      - ./.env
    ports:
      - "${SPARROW_API_PORT}:${SPARROW_API_PORT}"
    volumes:
      - ${HOST_DATA_FOLDER}:${CONTAINER_DATA_FOLDER:-/data}
    networks:
      - pyonb_ocr_api
    healthcheck:
      test: ["CMD", "curl", "-X", "POST", "http://localhost:${SPARROW_API_PORT}/sparrow-ocr"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s

  marker:
    profiles: [marker]
    build:
      context: src/ocr/marker
      dockerfile: Dockerfile
      args:
        <<: *build-args-common
        MARKER_API_PORT: ${MARKER_API_PORT}
    environment:
      <<: [*proxy-common, *common-env]
      CONTAINER_DATA_FOLDER: /data
      MARKER_API_PORT: ${MARKER_API_PORT}
    env_file:
      - ./.env
    ports:
      - "${MARKER_API_PORT}:${MARKER_API_PORT}"
    volumes:
      - ${HOST_DATA_FOLDER}:${CONTAINER_DATA_FOLDER:-/data}
    networks:
      - pyonb_ocr_api
    healthcheck:
      test: ["CMD", "curl", "-X", "POST", "http://localhost:${MARKER_API_PORT}/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s

  ocr-forwarding-api:
    build:
      context: src/api
      dockerfile: Dockerfile
      args:
        <<: *build-args-common
        OCR_FORWARDING_API_PORT: ${OCR_FORWARDING_API_PORT}
    environment:
      <<: [*proxy-common, *common-env]
      CONTAINER_DATA_FOLDER: /data
      OCR_FORWARDING_API_PORT: ${OCR_FORWARDING_API_PORT}
    env_file:
      - ./.env
    ports:
      - "${OCR_FORWARDING_API_PORT}:${OCR_FORWARDING_API_PORT}"
    volumes:
      - ./src/api/app:/app
      - ${HOST_DATA_FOLDER}:${CONTAINER_DATA_FOLDER:-/data}
    networks:
      - pyonb_ocr_api
    healthcheck:
      test: ["CMD", "curl", "-X", "POST", "http://localhost:${OCR_FORWARDING_API_PORT}/"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s