#  Copyright (c) University College London Hospitals NHS Foundation Trust
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
################################################################################


################################################################################
# Common
x-http-proxy: &http-proxy ${HTTP_PROXY}
x-https-proxy: &https-proxy ${HTTPS_PROXY}
x-no-proxy: &no-proxy localhost,0.0.0.0,127.0.0.1,uclvlddpragae02,backend-api,sparrow
x-proxy-common: &proxy-common
    HTTP_PROXY: *http-proxy
    http_proxy: *http-proxy
    HTTPS_PROXY: *https-proxy
    https_proxy: *https-proxy
    NO_PROXY: *no-proxy
    no_proxy: *no-proxy

x-build-args-common: &build-args-common
    <<: [*proxy-common]

x-common-env: &common-env
    DEBUG: ${DEBUG}
    LOG_LEVEL: ${LOG_LEVEL}
    TZ: ${TZ:-Europe/London}

networks:
  pyonb:

################################################################################
# Services
services:
  sparrow:
    profiles: [sparrow]
    build:
      context: sparrow
      dockerfile: Dockerfile
      args:
        <<: *build-args-common
    environment:
      <<: [*proxy-common, *common-env]
    ports:
      - "8001:8001"
    volumes:
      - ./images:/images

  backend-api:
    build:
      context: fastapi
      dockerfile: Dockerfile
      args:
        <<: *build-args-common
    environment:
      <<: [*proxy-common, *common-env]
    env_file:
      - ./.env
    ports:
      - "8080:8080"
    volumes:
      - ./fastapi/app:/app
      - ./images:/images